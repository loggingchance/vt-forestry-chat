<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VT Woods App</title>
  <style>
    :root{
      /* VTWoods site background (from your screenshot) */
      --bg: #FEE7A6;

      --text: #111111;
      --muted: rgba(0,0,0,.62);
      --border: rgba(0,0,0,.16);

      --panel: rgba(255,255,255,.62);
      --panel-strong: rgba(255,255,255,.80);

      --user-bg: rgba(255,255,255,.60);
      --asst-bg: rgba(255,255,255,.78);

      --btn-bg: #111111;
      --btn-text: #ffffff;

      --radius: 14px;
      --pad: 12px;
      --maxw: 720px;
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* iframe-friendly: full height, no outside margins */
    .app{
      height: 100%;
      display:flex;
      flex-direction: column;
      max-width: var(--maxw);
      margin: 0 auto;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
    }

    header{
      padding: 14px var(--pad) 10px;
      background: transparent;
    }
    h1{
      margin:0;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .chat{
      flex: 1 1 auto;
      overflow:auto;
      padding: 10px var(--pad);
      background: transparent;
    }

    .msg{
      display:flex;
      gap: 10px;
      margin: 10px 0;
      align-items:flex-start;
    }
    .badge{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-weight: 800;
      color: rgba(0,0,0,.65);
      background: var(--panel);
      flex: 0 0 auto;
      backdrop-filter: blur(3px);
    }

    .bubble{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 12px;
      font-size: 14.5px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
      width: 100%;
      background: var(--panel-strong);
      backdrop-filter: blur(3px);
    }
    .user .bubble{ background: var(--user-bg); }
    .assistant .bubble{ background: var(--asst-bg); }

    .bubble-top{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:center;
      margin-bottom: 8px;
    }
    .bubble-title{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .copybtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.75);
      color: var(--text);
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 12px;
      cursor:pointer;
      white-space: nowrap;
    }
    .copybtn:active{ transform: translateY(1px); }

    .controls{
      border-top: 1px solid var(--border);
      padding: 10px var(--pad);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(4px);
    }
    .row{
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    textarea{
      width: 100%;
      resize:none;
      min-height: 46px;
      max-height: 160px;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      font-size: 14.5px;
      outline:none;
      background: rgba(255,255,255,.85);
      color: var(--text);
    }
    textarea:focus{
      border-color: rgba(0,0,0,.35);
    }
    button.send{
      min-width: 90px;
      border: 1px solid var(--btn-bg);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      cursor:pointer;
    }
    button.send:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .bar{
      margin-top: 8px;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items:center;
      color: var(--muted);
      font-size: 12.5px;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .toggle input{ transform: translateY(1px); }

    .status{
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>VT Woods App</h1>
    </header>

    <div class="chat" id="chat" aria-live="polite"></div>

    <div class="controls">
      <div class="row">
        <textarea id="q" placeholder="Ask a Vermont forestry question…" spellcheck="true"></textarea>
        <button class="send" id="send">Ask</button>
      </div>

      <div class="bar">
        <label class="toggle">
          <input type="checkbox" id="wantCites" />
          Request citations
        </label>
        <div class="status" id="status">Ready</div>
      </div>
    </div>
  </div>

<script>
  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const send = document.getElementById('send');
  const statusEl = document.getElementById('status');
  const wantCites = document.getElementById('wantCites');

  function setBusy(busy){
    send.disabled = busy;
    q.disabled = busy;
    statusEl.textContent = busy ? 'Thinking…' : 'Ready';
  }

  function addUserMessage(text){
    const row = document.createElement('div');
    row.className = 'msg user';

    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = 'You';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;

    row.appendChild(badge);
    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function addAssistantMessage(text){
    const row = document.createElement('div');
    row.className = 'msg assistant';

    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = 'VT';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const top = document.createElement('div');
    top.className = 'bubble-top';

    const title = document.createElement('div');
    title.className = 'bubble-title';
    title.textContent = 'Answer';

    const btn = document.createElement('button');
    btn.className = 'copybtn';
    btn.type = 'button';
    btn.textContent = 'Copy';
    btn.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(text);
        btn.textContent = 'Copied';
        setTimeout(() => btn.textContent = 'Copy', 900);
      } catch(e){
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = 'Copied';
        setTimeout(() => btn.textContent = 'Copy', 900);
      }
    });

    top.appendChild(title);
    top.appendChild(btn);

    const body = document.createElement('div');
    body.textContent = text;

    bubble.appendChild(top);
    bubble.appendChild(body);

    row.appendChild(badge);
    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  // Robustly parse server responses (handles JSON or plain text)
  async function parseResponse(res){
    const raw = await res.text();

    // Try JSON first
    try{
      const data = JSON.parse(raw);

      // Accept multiple backend shapes
      // 1) { success:true, answer:"..." }
      // 2) { answer:"..." }
      // 3) { output:"..." } or { message:"..." }
      if (typeof data.answer === 'string') return { ok: true, answer: data.answer };
      if (typeof data.output === 'string') return { ok: true, answer: data.output };
      if (typeof data.message === 'string') return { ok: true, answer: data.message };

      if (data.success === false) {
        return { ok: false, error: data.error || 'Unknown error' };
      }

      // Fall back to showing the whole JSON if it’s something unexpected
      return { ok: true, answer: raw };
    } catch(e){
      // Not JSON: treat as plain text
      return { ok: res.ok, answer: raw || ('HTTP ' + res.status) };
    }
  }

  async function ask(){
    const raw = q.value.trim();
    if(!raw) return;

    addUserMessage(raw);
    q.value = '';
    q.style.height = '46px';

    setBusy(true);

    const msg = wantCites.checked
      ? `${raw}\n\nProvide citations (document title + page/section) in this response.`
      : raw;

    try{
      const res = await fetch('/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: msg })
      });

      const parsed = await parseResponse(res);

      if(!res.ok){
        addAssistantMessage(`Error: HTTP ${res.status}`);
      } else if(!parsed.ok){
        addAssistantMessage(`Error: ${parsed.error}`);
      } else {
        const ans = (parsed.answer || '').trim();
        addAssistantMessage(ans || '(No answer returned)');
      }
    } catch(e){
      addAssistantMessage(`Error: ${e.message || e}`);
    } finally {
      setBusy(false);
      q.focus();
    }
  }

  // Autosize textarea
  q.addEventListener('input', () => {
    q.style.height = 'auto';
    q.style.height = Math.min(q.scrollHeight, 160) + 'px';
  });

  // Enter sends; Shift+Enter newline
  q.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      ask();
    }
  });

  send.addEventListener('click', ask);

  // Seed message
  addAssistantMessage(
`Ask a Vermont forestry question.

Examples:
- What do Vermont AMPs require for stream crossings?
- How do I reduce erosion risk on skid trails in wet conditions?
- When should I use a portable bridge vs. a culvert in Vermont?`
  );
</script>
</body>
</html>
